from csv import reader
from math import ceil
from pickle import dump, load
from os import listdir
from os.path import basename, join

observations_per_file = 10

with open('gen/features.p', 'rb') as file:
    features = load(file)
with open('labels.csv', 'r') as file:
    label_reader = reader(file)
    next(label_reader)
    positive_observations = []
    for row in label_reader:  # Without header row
        positive_observations.append(row[0])
paths = [join('feature_vectors', f) for f in listdir('feature_vectors')]
fill_nr = len(str(len(paths) // observations_per_file))
observations = []
for i in range(len(paths)):
    path = paths[i]
    print('Observation ' + str(i) + ' of ' + str(len(paths)), path)
    with open(path, 'r') as file:
        observation = []
        lines = file.read().splitlines()
        for feature in features:
            if feature in lines:
                observation.append(1)
            else:
                observation.append(0)
        if basename(path) in positive_observations:
            observation.append(1)
        else:
            observation.append(0)
        observations.append(observation)
    if (i + 1) % observations_per_file == 0:
        with open('gen/observations-' + str((i + 1) // observations_per_file).zfill(fill_nr) + '.p', 'wb') as file:
            dump(observations, file)
        observations = []

with open('gen/observations-' + str(int(ceil(i / observations_per_file))) + '.p', 'wb') as file:
    dump(observations, file)
